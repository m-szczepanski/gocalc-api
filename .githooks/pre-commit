#!/bin/sh
# Pre-commit hook for gocalc-api
# This hook runs code quality checks before allowing a commit
# To install: git config core.hooksPath .githooks

set -e

echo "Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if gofmt is needed
echo "${YELLOW}[1/5]${NC} Checking code format..."
UNFORMATTED=$(gofmt -s -l . | grep -v '^vendor/' || true)
if [ -n "$UNFORMATTED" ]; then
    echo "${RED}Code is not formatted. Please run 'make fmt' or 'gofmt -s -w .'${NC}"
    echo "Files that need formatting:"
    echo "$UNFORMATTED"
    exit 1
fi
echo "${GREEN}Code format check passed${NC}"

# Run go vet
echo "${YELLOW}[2/5]${NC} Running go vet..."
if ! go vet ./...; then
    echo "${RED}go vet failed${NC}"
    exit 1
fi
echo "${GREEN}go vet passed${NC}"

# Check for golangci-lint
echo "${YELLOW}[3/5]${NC} Running golangci-lint..."
if ! command -v golangci-lint &> /dev/null; then
    echo "${YELLOW}golangci-lint not installed. Skipping lint check.${NC}"
    echo "  Install with: make install-tools"
else
    if ! golangci-lint run ./...; then
        echo "${RED}golangci-lint failed${NC}"
        exit 1
    fi
    echo "${GREEN}golangci-lint passed${NC}"
fi

# Verify go.mod is tidy
echo "${YELLOW}[4/5]${NC} Checking go.mod..."
go mod tidy
if ! git diff --exit-code go.mod go.sum; then
    echo "${RED}go.mod or go.sum is not tidy${NC}"
    echo "  Please run 'make tidy' and commit the changes"
    exit 1
fi
echo "${GREEN}go.mod check passed${NC}"

# Run tests
Uncomment the following lines if you want to run tests before every commit
echo "${YELLOW}[5/5]${NC} Running tests..."
if ! go test -short ./...; then
    echo "${RED}Tests failed${NC}"
    exit 1
fi
echo "${GREEN}Tests passed${NC}"

echo "${YELLOW}[5/5]${NC} Skipping tests (run manually with 'make test')"

echo ""
echo "${GREEN}All pre-commit checks passed!${NC}"
echo ""
